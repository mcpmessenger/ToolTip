version: 1
frontend:
  phases:
    preBuild:
      commands:
        - echo "ðŸš€ Starting ToolTip Companion v1.1 build..."
        - echo "ðŸ“¦ Using frontend-only build without canvas dependencies..."
        - cp package-amplify.json package.json
        - npm ci
    build:
      commands:
        - echo "ðŸ—ï¸ Building frontend..."
        - npm run build
        - echo "ðŸ“¦ Installing backend dependencies..."
        - cd backend
        - npm ci
        - echo "ðŸ—ï¸ Building backend..."
        - npm run build
        - cd ..
        - echo "ðŸ“ Creating deployment structure..."
        - mkdir -p dist/backend
        - cp -r backend/dist/* dist/backend/
        - cp backend/package.json dist/backend/
        - echo "ðŸ“‹ Creating server.js..."
        - cat > dist/server.js << 'EOF'
        - const express = require('express');
        - const path = require('path');
        - const cors = require('cors');
        - const app = express();
        - const PORT = process.env.PORT || 3000;
        - app.use(cors());
        - app.use(express.static(path.join(__dirname)));
        - app.use('/api', require('./backend'));
        - app.get('*', (req, res) => {
        -   res.sendFile(path.join(__dirname, 'index.html'));
        - });
        - app.listen(PORT, () => {
        -   console.log(`ðŸš€ Server running on port ${PORT}`);
        - });
        - EOF
    postBuild:
      commands:
        - echo "âœ… Build completed successfully!"
        - echo "ðŸ“Š Build artifacts ready for deployment"
  artifacts:
    baseDirectory: dist
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - backend/node_modules/**/*
